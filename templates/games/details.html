{% extends "gameplan/base.html" %}
{% load static %}

{% block content %}
    <section id="top-image"></section>

    <div class="container">
        <section id="top-info-section">
            <div class="row d-flex flex-row" id="top-info-box">
                <div class="col-12 col-lg-3"><img id="top-cover-img">
                </div>
                <div class="col-12 col-lg-9 flex-column" id="top-info-text-holder">
                    <div class="row">
                        <div class="col">
                            <h1 id="game-name-heading"></h1>
                        </div>
                    </div>
                    <div class="row" id="top-info-text">
                        <div class="col" id="top-info-table-holder">
                            <div id="top-info-button-holder">
                                <form class="top-info-form">
                                    <button aria-haspopup="true" class="btn btn-outline-primary" id="wishlist-button"
                                            onclick="return addRemoveAttribute('wishlist')" type="button">Add to wishlist
                                    </button>
                                </form>
                                <form class="top-info-form">
                                    <button title="Buy now" aria-haspopup="true" class="btn btn-outline-primary"
                                            id="buy-title-button"
                                            onclick="return buyTitle()" type="button">Buy now
                                        <i class="fas fa-shopping-bag" style="margin-left: 8px"></i>
                                    </button>
                                </form>
                                <form class="top-info-form">
                                    <button aria-haspopup="true" class="btn btn-outline-primary" id="dislike-button"
                                            onclick="return addRemoveAttribute('dislike')" type="button">Dislike
                                    </button>
                                </form>
                            </div>

                            <div class="table-responsive table-borderless">
                                <table class="table" id="info-table">
                                    <tbody class="d-inline-block float-left">
                                    <tr>
                                        <td class="left-cell">Developer</td>
                                        <td class="cell-field" id="top-info-developer"></td>
                                    </tr>
                                    <tr>
                                        <td class="left-cell">Publisher</td>
                                        <td class="cell-field" id="top-info-publisher"></td>
                                    </tr>
                                    <tr>
                                        <td class="left-cell">Genres</td>
                                        <td class="cell-field" id="top-info-genres"></td>
                                    </tr>
                                    <tr>
                                        <td class="left-cell">Platforms</td>
                                        <td class="cell-field" id="top-info-platforms"></td>
                                    </tr>
                                    <tr>
                                        <td class="left-cell">Release date</td>
                                        <td class="cell-field" id="top-info-release-date"></td>
                                    </tr>
                                    <tr id="rating-top-section">
                                        <td class="left-cell">Rating</td>
                                        <td class="cell-field" id="top-info-rating">
                                            <i class="far fa-star"></i>
                                            <i class="far fa-star"></i>
                                            <i class="far fa-star"></i>
                                            <i class="far fa-star"></i>
                                            <i class="far fa-star"></i>
                                            <p id="top-info-rating-count"></p>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="body-section">
            <div class="row">
                <div class="col-lg-6">
                    <h2 class="section-heading heading-underline">Summary</h2>
                    <p id="body-summary"></p>
                </div>
                <div class="col-lg-6">
                    <h2 class="section-heading heading-underline">Screenshots</h2>
                    <div class="carousel slide" data-ride="carousel" id="carousel" data-interval="6000">
                        <div class="carousel-inner" id="carousel-inner" role="listbox"></div>
                        <div>
                            <a class="carousel-control-prev" href="#carousel" role="button" data-slide="prev">
                                <span class="carousel-control-prev-icon"></span>
                                <span class="sr-only">Previous</span>
                            </a>
                            <a class="carousel-control-next" href="#carousel" role="button" data-slide="next">
                                <span class="carousel-control-next-icon"></span><span class="sr-only">Next</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <section id="screenshots-section">

        </section>

        <section id="section-rec-bought-together">
            <h2 class="section-heading heading-underline">Frequently bought with this game</h2>
            <div class="slider"></div>
        </section>

        <section id="section-rec-similar">
            <h2 class="section-heading heading-underline">Similar to this game</h2>
            <div class="slider"></div>
        </section>

    </div>

    <script>
        let gameId = {{ request.resolver_match.kwargs.game_id }};
        let currentTitle;

        $(document).ready(function () {
            getGameDetails(gameId);
            logDetailViewEvent(gameId, csrftoken, sessionid);

            const boughtTogetherElement = document.getElementById('section-rec-bought-together');
            getBoughtTogetherRecommendations(gameId, boughtTogetherElement);

            const contentElement = document.getElementById('section-rec-similar');
            getContentRecommendations(gameId, contentElement);
        });

        function addRemoveAttribute(attribute) {
            gameId = {{ request.resolver_match.kwargs.game_id }}
                $.ajax({
                        type: 'POST',
                        url: '{% url 'add_remove_attribute' %}',
                        data: {
                            'game_id': gameId,
                            'attribute': attribute,
                            'csrfmiddlewaretoken': '{{ csrf_token }}',
                        },
                        success: function (result) {
                            if (result['auth']) {
                                showHideAttributeIcon(attribute, result['is_' + attribute]);
                                if (attribute === 'wishlist' && result['is_' + attribute]) logWishlistEvent(gameId, csrftoken, sessionid);
                            } else {
                                window.location.replace('{% url 'login' %}?next={{ request.path }}')
                            }
                        },
                    }
                );
            return false;
        }

        function showHideAttributeIcon(attribute, show) {
            let icon = document.createElement('i');
            icon.setAttribute('style', 'margin-left: 8px');
            let button = document.getElementById(attribute + '-button');
            if (show) {
                if (attribute === 'wishlist') {
                    icon.setAttribute('class', 'fas fa-heart');
                    button.setAttribute('title', 'Remove from wishlist');
                    button.innerHTML = "Remove from wishlist";
                }
                else if (attribute === 'dislike') {
                    icon.setAttribute('class', 'fas fa-thumbs-down');
                    button.setAttribute('title', 'Show me this game in recommendations');
                    button.innerHTML = "Undislike";
                }
                button.appendChild(icon);
            } else {
                if (attribute === 'wishlist') {
                    icon.setAttribute('class', 'far fa-heart');
                    button.setAttribute('title', 'Add to wishlist');
                    button.innerHTML = "Add to wishlist";
                }
                else if (attribute === 'dislike') {
                    icon.setAttribute('class', 'far fa-thumbs-down');
                    button.setAttribute('title', 'Don\'t show me this game in recommendations');
                    button.innerHTML = "Dislike";
                }
                button.appendChild(icon);
            }
        }

        function buyTitle() {
            logPurchaseEvent(gameId, csrftoken, sessionid);
            alert("Game purchased");
        }

        // DETAILS
        function getGameDetails(gameId) {
            let url = '/games/details/' + gameId;
            $.getJSON(url, function (game) {
                if (game != null) {
                    currentTitle = game;

                    // TOP IMAGE
                    let topImage = document.getElementById('top-image');
                    topImage.setAttribute('style', 'background-image: url(https://' + game[0]['screenshots'][0]['url'] + ')');

                    // COVER IMAGE
                    let coverImage = document.getElementById('top-cover-img');
                    coverImage.setAttribute('src', 'https://' + game[0]['cover']);

                    // TITLE
                    let gameNameHeading = document.getElementById('game-name-heading');
                    gameNameHeading.innerHTML = game[0]['title'];
                    document.title = game[0]['title'] + ' | GamePlan';

                    // RATING
                    let ratingCount = game[0]['total_rating_count'];

                    if (ratingCount != null && ratingCount > 0) {
                        let rating = game[0]['total_rating'];
                        rating = Math.round(rating);

                        let ratingCountTopInfo = document.getElementById('top-info-rating-count');
                        ratingCountTopInfo.innerHTML = rating + '% positive (' + ratingCount + ' reviews)';

                        let ratingTopInfo = document.getElementById('top-info-rating');
                        let stars = ratingTopInfo.children;
                        if (rating > 5) {
                            stars[0].setAttribute('class', 'fas fa-star-half-alt');
                        }
                        if (rating > 15) {
                            stars[0].setAttribute('class', 'fas fa-star');
                        }
                        if (rating > 25) {
                            stars[1].setAttribute('class', 'fas fa-star-half-alt');
                        }
                        if (rating > 35) {
                            stars[1].setAttribute('class', 'fas fa-star');
                        }
                        if (rating > 45) {
                            stars[2].setAttribute('class', 'fas fa-star-half-alt');
                        }
                        if (rating > 55) {
                            stars[2].setAttribute('class', 'fas fa-star');
                        }
                        if (rating > 65) {
                            stars[3].setAttribute('class', 'fas fa-star-half-alt');
                        }
                        if (rating > 75) {
                            stars[3].setAttribute('class', 'fas fa-star');
                        }
                        if (rating > 85) {
                            stars[4].setAttribute('class', 'fas fa-star-half-alt');
                        }
                        if (rating > 95) {
                            stars[4].setAttribute('class', 'fas fa-star');
                        }
                    } else {
                        document.getElementById('rating-top-section').setAttribute('style', 'display: none;');
                    }

                    // COMPANIES
                    let developerTopInfo = document.getElementById('top-info-developer');
                    let publisherTopInfo = document.getElementById('top-info-publisher');
                    for (let i = 0; i < game[0]['involved_companies'].length; i++) {
                        if (game[0]['involved_companies'][i]['is_dev'] === true) {
                            if (developerTopInfo.innerHTML !== '') developerTopInfo.innerHTML = developerTopInfo.innerHTML + ", ";
                            let developerLink = document.createElement('a');
                            //developerLink.setAttribute('href', '/company/' + game[0]['involved_companies'][i]['company_id']);
                            developerLink.innerHTML = game[0]['involved_companies'][i]['name'];
                            developerTopInfo.appendChild(developerLink);
                        }
                        if (game[0]['involved_companies'][i]['is_pub'] === true) {
                            if (publisherTopInfo.innerHTML !== '') publisherTopInfo.innerHTML = publisherTopInfo.innerHTML + ", ";
                            let publisherLink = document.createElement('a');
                            //publisherLink.setAttribute('href', '/company/' + game[0]['involved_companies'][i]['company_id']);
                            publisherLink.innerHTML = game[0]['involved_companies'][i]['name'];
                            publisherTopInfo.appendChild(publisherLink);
                        }
                    }

                    // GENRES
                    let genresTopInfo = document.getElementById('top-info-genres');
                    for (var i = 0; i < game[0]['genres'].length; i++) {
                        if (genresTopInfo.innerHTML !== '') genresTopInfo.innerHTML = genresTopInfo.innerHTML + ", ";
                        genreLink = document.createElement('a');
                        genreLink.setAttribute('href', '/search/?q=&genres=' + game[0]['genres'][i]['genre_id']);
                        genreLink.innerHTML = game[0]['genres'][i]['name'];
                        genresTopInfo.appendChild(genreLink);
                    }

                    // PLATFORMS
                    let platformsTopInfo = document.getElementById('top-info-platforms');
                    for (let i = 0; i < game[0]['platform'].length; i++) {
                        if (platformsTopInfo.innerHTML !== '') platformsTopInfo.innerHTML = platformsTopInfo.innerHTML + ", ";
                        platformLink = document.createElement('a');
                        platformLink.setAttribute('href', '/search/?q=&platforms=' + game[0]['platform'][i]['platform_id']);
                        platformLink.innerHTML = game[0]['platform'][i]['name'];
                        platformsTopInfo.appendChild(platformLink);
                    }

                    // RELEASE DATE
                    let releaseDateTopInfo = document.getElementById('top-info-release-date');
                    let unixTime = game[0]['first_release_date'];
                    let months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October',
                        'November', 'December'];
                    let date = new Date(unixTime * 1000); // Converting to millis
                    let day = date.getDate();
                    let month = months[date.getMonth()];
                    let year = date.getFullYear();
                    releaseDateTopInfo.innerHTML = day + ' ' + month + ' ' + year;

                    if (developerTopInfo.innerHTML === '') {
                        developerTopInfo.innerHTML = 'Unknown'
                    }

                    if (publisherTopInfo.innerHTML === '') {
                        publisherTopInfo.innerHTML = 'Unknown'
                    }

                    // SUMMARY
                    let summaryInfo = document.getElementById('body-summary');
                    summaryInfo.innerHTML = game[0]['summary'];

                    // SCREENSHOTS
                    screenshotsSection = document.getElementById('carousel-inner');
                    for (let i = 0; i < game[0]['screenshots'].length; i++) {
                        let carouselItemDiv = document.createElement('div');
                        if (i === 0) carouselItemDiv.setAttribute('class', 'carousel-item active');
                        else carouselItemDiv.setAttribute('class', 'carousel-item');

                        carouselItemImg = document.createElement('img');
                        carouselItemImg.setAttribute('class', 'w-100 d-block');
                        carouselItemImg.setAttribute('src', 'https://' + game[0]['screenshots'][i]['url']);
                        carouselItemImg.setAttribute('title', game[0]['title']);

                        carouselItemDiv.appendChild(carouselItemImg);
                        screenshotsSection.appendChild(carouselItemDiv);
                    }

                    showHideAttributeIcon('wishlist', game[0]['on_wishlist']);
                    showHideAttributeIcon('dislike', game[0]['is_disliked']);
                }
            });
        }

    </script>
{% endblock content %}
